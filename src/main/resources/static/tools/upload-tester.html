<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>업로드/게시 테스트 도구</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --ok:#22c55e; --err:#ef4444; --pri:#60a5fa; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: #e5e7eb; }
    header { padding: 16px 20px; border-bottom: 1px solid #1f2937; display:flex; align-items:center; gap:12px; }
    header h1 { font-size: 18px; margin: 0; }
    main { padding: 20px; display:grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .card { background: var(--card); border: 1px solid #1f2937; border-radius: 10px; padding: 16px; }
    .card h2 { font-size: 16px; margin: 0 0 12px; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input[type="text"], input[type="password"], textarea { width:100%; background: #0b1220; color:#e5e7eb; border:1px solid #1f2937; border-radius:8px; padding:10px 12px; outline:none; }
    input[type="file"] { color:#e5e7eb; }
    textarea { min-height: 160px; resize: vertical; }
    button { background:#1d4ed8; border:none; color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#334155; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .muted { color: var(--muted); font-size: 12px; }
    .log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#0b1220; border:1px solid #1f2937; border-radius:8px; padding:10px; height:160px; overflow:auto; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; font-size:12px; }
    .ok { color: var(--ok); }
    .err { color: var(--err); }
    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .small { font-size: 12px; }
    .mt8 { margin-top:8px; }
    .preview { background:#0b1220; border:1px solid #1f2937; border-radius:8px; padding:10px; min-height:160px; }
    .preview img, .preview video { max-width:100%; height:auto; }
  </style>
  <!-- 테스트 페이지 전용: 마크다운 렌더 + XSS 방지 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
  <header>
    <h1>업로드/게시 테스트 도구</h1>
    <span class="pill" id="authState">미인증</span>
  </header>

  <main>
    <section class="card">
      <h2>1) 로그인</h2>
  <label for="baseUrl">백엔드 베이스 URL (비우면 현재 오리진 사용)</label>
  <input id="baseUrl" type="text" placeholder="예: https://abcd1234.ngrok.io" />

      <div class="grid-2 mt8">
        <div>
          <label for="loginId">아이디</label>
          <input id="loginId" type="text" placeholder="admin 또는 custom id" />
        </div>
        <div>
          <label for="loginPw">비밀번호</label>
          <input id="loginPw" type="password" placeholder="password" />
        </div>
      </div>

      <div class="row mt8">
        <button id="btnLogin">로그인</button>
        <button class="secondary" id="btnLogout">토큰 지우기</button>
      </div>
      <div class="muted mt8">토큰: <span id="tokenPreview" class="small"></span></div>
    </section>

    <section class="card">
      <h2>2) 파일 업로드</h2>
      <div class="grid-2">
        <div>
          <label for="imgFile">이미지 업로드</label>
          <input id="imgFile" type="file" accept="image/*" />
          <div class="row mt8">
            <button id="btnUploadImg">/api/files/images 업로드</button>
            <button class="secondary" id="btnInsertImg">MD 삽입</button>
          </div>
          <div class="muted mt8">응답 URL: <span id="imgUrl"></span></div>
        </div>
        <div>
          <label for="vidFile">영상 업로드</label>
          <input id="vidFile" type="file" accept="video/*" />
          <div class="row mt8">
            <button id="btnUploadVid">/api/files/videos 업로드</button>
            <button class="secondary" id="btnInsertVid">MD 삽입</button>
          </div>
          <div class="muted mt8">응답 URL: <span id="vidUrl"></span></div>
        </div>
      </div>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
      <h2>3) 게시물 작성</h2>
  <label for="title">제목</label>
  <input id="title" type="text" maxlength="20" placeholder="제목(최대 20자)" />

  <label class="mt8" for="richEditor">간편 에디터 (마우스로 클릭 후 텍스트 입력 • 아래 버튼/붙여넣기/드래그-드롭으로 미디어 추가)</label>
  <div id="richToolbar" class="row mt8">
    <button class="secondary" id="btnRichAddImage">에디터에 이미지 업로드+삽입</button>
    <button class="secondary" id="btnRichAddVideo">에디터에 영상 업로드+삽입</button>
    <span class="muted" style="align-self:center;">또는 에디터에 바로 붙여넣기/드롭</span>
  </div>
  <div id="richEditor" class="preview" contenteditable="true" style="min-height:200px;"></div>
  <div class="muted mt8">참고: 이 에디터의 내부 HTML은 그대로 content(contentMd 호환)로 전송됩니다.</div>

  <div class="grid-2 mt8">
    <div>
      <label for="imageFilesMulti">(선택) 함께 보낼 이미지 파일들</label>
      <input id="imageFilesMulti" type="file" accept="image/*" multiple />
    </div>
    <div>
      <label for="videoFilesMulti">(선택) 함께 보낼 영상 파일들</label>
      <input id="videoFilesMulti" type="file" accept="video/*" multiple />
    </div>
  </div>

  <label class="mt8" for="contentMd">content (마크다운/HTML)</label>
  <textarea id="contentMd" placeholder="여기에 마크다운/HTML 입력. 위에서 업로드 후 'MD 삽입'으로 빠르게 추가."></textarea>

  <div class="grid-2 mt8">
    <div>
      <label for="isDev">개발글 여부(isDev)</label>
      <select id="isDev">
        <option value="">미설정</option>
        <option value="true">개발</option>
        <option value="false">일반</option>
      </select>
    </div>
    <div>
      <label for="devTags">개발 언어 태그(devTags, CSV)</label>
      <input id="devTags" type="text" placeholder="예: Python,C,JavaScript" />
    </div>
  </div>

      <div class="row mt8">
        <button id="btnCreatePost">POST /post</button>
        <button class="secondary" id="btnPreview">미리보기 렌더</button>
      </div>

      <div class="mt8">
        <div class="muted">생성된 게시물 UUID: <span id="createdUuid"></span></div>
        <div class="muted mt8">미리보기</div>
        <div id="mdPreview" class="preview"></div>
      </div>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
      <h2>4) 생성된 게시물 상세 보기</h2>
      <div class="row">
        <button class="secondary" id="btnFetchCreated">/post/view 호출</button>
        <a id="openBrowser" class="secondary" href="#" target="_blank" style="display:inline-block; text-decoration:none; padding:10px 14px; border-radius:8px; background:#334155; color:#fff;">목록 뷰어로 열기</a>
      </div>
      <div class="muted mt8">아래 영역은 서버에서 받은 contentMd를 렌더링합니다.</div>
      <div id="createdPreview" class="preview" style="margin-top:8px;"></div>
    </section>

    <section class="card" style="grid-column: 1 / -1;">
      <h2>로그</h2>
      <div id="log" class="log"></div>
    </section>
  </main>

<script>
(function(){
  const $ = (id) => document.getElementById(id);
  const authState = $("authState");
  const tokenPreview = $("tokenPreview");
  const logEl = $("log");
  const state = { token: null };

  const base = () => {
    const v = $("baseUrl").value.trim();
    return v || globalThis.location.origin;
  };
  const headers = () => state.token ? { "Authorization": `Bearer ${state.token}` } : {};
  const log = (msg) => {
    const dt = new Date().toLocaleTimeString();
    logEl.innerHTML = `[${dt}] ${msg}` + (logEl.innerHTML ? "\n" + logEl.innerHTML : "");
  };
  const setToken = (t) => {
    state.token = t;
    if (t) {
      authState.textContent = '인증됨';
      tokenPreview.textContent = t.slice(0,24) + '...';
    } else {
      authState.textContent = '미인증';
      tokenPreview.textContent = '';
    }
  };

  $("btnLogin").addEventListener('click', async () => {
    const id = $("loginId").value.trim();
    const password = $("loginPw").value;
    try {
      const res = await fetch(base() + '/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, password })
      });
      const json = await res.json();
      if (!res.ok || !json.success) throw new Error(json.message || 'login failed');
      const data = json.data || {};
      const token = data.accessToken;
      if (!token) throw new Error('no accessToken in response');
      setToken(token);
  log('로그인 성공. accessToken 저장됨');
    } catch (e) {
  log('로그인 실패: ' + e.message);
    }
  });

  $("btnLogout").addEventListener('click', () => {
    setToken(null);
    log('토큰 삭제됨');
  });

  // 이미지 업로드
  $("btnUploadImg").addEventListener('click', async () => {
    const f = $("imgFile").files[0];
  if (!f) { log('이미지 파일을 선택하세요'); return; }
  if (!state.token) { log('먼저 로그인하세요'); return; }
    const fd = new FormData();
    fd.append('file', f);
    try {
      const res = await fetch(base() + '/api/files/images', { method: 'POST', headers: headers(), body: fd });
      const json = await res.json();
      if (!res.ok || !json.success) throw new Error(json.message || 'upload failed');
      const url = (json.data && json.data.url) || '';
      $("imgUrl").textContent = url;
  log('이미지 업로드 성공: ' + url);
  } catch (e) { log('이미지 업로드 실패: ' + e.message); }
  });

  // 영상 업로드
  $("btnUploadVid").addEventListener('click', async () => {
    const f = $("vidFile").files[0];
  if (!f) { log('영상 파일을 선택하세요'); return; }
  if (!state.token) { log('먼저 로그인하세요'); return; }
    const fd = new FormData();
    fd.append('file', f);
    try {
      const res = await fetch(base() + '/api/files/videos', { method: 'POST', headers: headers(), body: fd });
      const json = await res.json();
      if (!res.ok || !json.success) throw new Error(json.message || 'upload failed');
      const url = (json.data && json.data.url) || '';
      $("vidUrl").textContent = url;
  log('영상 업로드 성공: ' + url);
  } catch (e) { log('영상 업로드 실패: ' + e.message); }
  });

  // 에디터에 마크다운 삽입
  function gatherSelectedFiles(){
    return { imgs: $("imageFilesMulti").files, vids: $("videoFilesMulti").files };
  }
  function validateSizes(files){
    const MAX_FILE = 100 * 1024 * 1024;
    const MAX_REQ = 200 * 1024 * 1024;
    let total = 0; const tooBig = [];
    const pushCheck = f => { total += f.size; if (f.size > MAX_FILE) tooBig.push(f.name); };
    if (files.imgs) for (const f of files.imgs) pushCheck(f);
    if (files.vids) for (const f of files.vids) pushCheck(f);
    return { total, tooBig, MAX_REQ };
  }
  async function submitPost(title, contentMd, isDev, devTags, files){
    const fd = new FormData();
    const payload = { title, contentMd };
    if (isDev !== undefined && isDev !== null) payload.isDev = isDev;
    if (devTags) payload.devTags = devTags;
    fd.append('data', new Blob([JSON.stringify(payload)], { type:'application/json' }), 'data.json');
    if (files.imgs && files.imgs.length) for (const f of files.imgs) fd.append('imageFiles', f);
    if (files.vids && files.vids.length) for (const f of files.vids) fd.append('videoFiles', f);
    const res = await fetch(base() + '/post/multipart', { method:'POST', headers: headers(), body: fd });
    const json = await res.json();
    if (!res.ok || !json.success) throw new Error(json.message || 'create failed');
    return json.data;
  }
  // 게시물 생성 (리팩터 후 단일 핸들러)
  $("btnCreatePost").addEventListener('click', async () => {
    if (!state.token) { log('먼저 로그인하세요'); return; }
    const title = $("title").value.trim();
    if (!title) { log('제목을 입력하세요'); return; }
    const contentMd = $("richEditor").innerHTML.trim() || $("contentMd").value;
    const isDevSel = $("isDev").value;
    const isDev = isDevSel === '' ? null : (isDevSel === 'true');
    const devTags = $("devTags").value.trim();
    const files = gatherSelectedFiles();
    const { total, tooBig, MAX_REQ } = validateSizes(files);
    if (tooBig.length) { log('파일이 너무 큽니다(>100MB): ' + tooBig.join(', ')); return; }
    if (total > MAX_REQ) { log('전체 요청 용량 초과(>200MB). 파일 수를 줄이세요.'); return; }
    try {
      const uuid = await submitPost(title, contentMd, isDev, devTags, files);
      $("createdUuid").textContent = uuid;
      log('게시물 생성 성공(멀티파트). uuid=' + uuid);
      $("openBrowser").href = base() + '/tools/posts-browser.html?uuid=' + encodeURIComponent(uuid);
    } catch(e){ log('게시물 생성 실패: ' + e.message); }
  });
  // (불필요하게 남아있던 잘린 코드 조각 제거)

  // 간편 에디터: 이미지/비디오 업로드 + 삽입 버튼
  $("btnRichAddImage").addEventListener('click', async () => {
    if (!state.token) { log('먼저 로그인하세요'); return; }
    const picker = document.createElement('input');
    picker.type = 'file';
    picker.accept = 'image/*';
    picker.onchange = async () => {
      const f = picker.files && picker.files[0];
      if (!f) return;
      try {
        const url = await uploadSingle('image', f);
        insertHtmlAtCursor(`<img src="${url}" alt="" />`);
        log('에디터에 이미지 삽입: ' + url);
      } catch(e){ log('이미지 업로드 실패: ' + e.message); }
    };
    picker.click();
  });
  $("btnRichAddVideo").addEventListener('click', async () => {
    if (!state.token) { log('먼저 로그인하세요'); return; }
    const picker = document.createElement('input');
    picker.type = 'file';
    picker.accept = 'video/*';
    picker.onchange = async () => {
      const f = picker.files && picker.files[0];
      if (!f) return;
      try {
        const url = await uploadSingle('video', f);
        insertHtmlAtCursor(`<video controls src="${url}" style="max-width:100%"></video>`);
        log('에디터에 영상 삽입: ' + url);
      } catch(e){ log('영상 업로드 실패: ' + e.message); }
    };
    picker.click();
  });

  // 간편 에디터: 붙여넣기/드래그-드롭 업로드 처리
  const rich = $("richEditor");
  function extractFilesFromClipboard(e){
    const items = e.clipboardData && e.clipboardData.items;
    if (!items) return [];
    const out = [];
    for (const it of items){
      if (it.kind === 'file'){
        const f = it.getAsFile();
        if (f) out.push(f);
      }
    }
    return out;
  }
  async function uploadAndInsertFiles(files, source){
    if (!files || files.length === 0) return;
    if (!state.token) { log('먼저 로그인하세요'); return; }
    for (const f of files){
      const isImg = f.type && f.type.startsWith('image/');
      const isVid = f.type && f.type.startsWith('video/');
      if (!isImg && !isVid) continue;
      const url = await uploadSingle(isImg ? 'image' : 'video', f);
      insertHtmlAtCursor(isImg ? `<img src="${url}" alt="" />` : `<video controls src="${url}" style="max-width:100%"></video>`);
      log(`에디터에 ${source} 업로드 삽입: ${url}`);
    }
  }
  rich.addEventListener('paste', async (e) => {
    try {
      const files = extractFilesFromClipboard(e);
      if (files.length === 0) return;
      e.preventDefault();
      await uploadAndInsertFiles(files, '붙여넣기');
    } catch (err){ log('붙여넣기 처리 실패: ' + err.message); }
  });
  rich.addEventListener('dragover', (e) => { e.preventDefault(); });
  rich.addEventListener('drop', async (e) => {
    try {
      e.preventDefault();
      const dt = e.dataTransfer;
      if (!dt || !dt.files || dt.files.length === 0) return;
      if (!state.token) { log('먼저 로그인하세요'); return; }
      for (const f of dt.files){
        const isImg = f.type && f.type.startsWith('image/');
        const isVid = f.type && f.type.startsWith('video/');
        if (!isImg && !isVid) continue;
        const url = await uploadSingle(isImg ? 'image' : 'video', f);
        insertHtmlAtCursor(isImg ? `<img src="${url}" alt="" />` : `<video controls src="${url}" style="max-width:100%"></video>`);
        log('에디터에 드롭 업로드 삽입: ' + url);
      }
    } catch (err){ log('드롭 처리 실패: ' + err.message); }
  });

  // 게시물 생성 (multipart 통합 엔드포인트 사용)
  $("btnCreatePost").addEventListener('click', async () => {
    if (!state.token) { log('먼저 로그인하세요'); return; }
    const title = $("title").value.trim();
    const richHtml = $("richEditor").innerHTML.trim();
    const contentMd = richHtml || $("contentMd").value;
    if (!title) { log('제목을 입력하세요'); return; }
    // 클라이언트 측 간단 사이즈 체크 (서버 제한: 파일=100MB, 요청=200MB)
    const MAX_FILE = 100 * 1024 * 1024;
    const MAX_REQ = 200 * 1024 * 1024;
    let totalSize = 0;
    const imgs = $("imageFilesMulti").files;
    const vids = $("videoFilesMulti").files;
    const tooBig = [];
    if (imgs) {
      for (const f of imgs){
        totalSize += f.size; if (f.size > MAX_FILE) tooBig.push(`이미지: ${f.name}`);
      }
    }
    if (vids) {
      for (const f of vids){
        totalSize += f.size; if (f.size > MAX_FILE) tooBig.push(`영상: ${f.name}`);
      }
    }
    if (tooBig.length) { log('파일이 너무 큽니다 (100MB 제한): ' + tooBig.join(', ')); return; }
    if (totalSize > MAX_REQ) { log('전체 요청 크기가 너무 큽니다 (200MB 제한). 선택 파일 수를 줄이세요.'); return; }
    try {
      const fd = new FormData();
      const payload = { title, contentMd };
      const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
      fd.append('data', blob, 'data.json');
      // 선택된 이미지/영상 파일들을 함께 보냅니다(동시 업로드)
      const imgs = $("imageFilesMulti").files;
      const vids = $("videoFilesMulti").files;
      if (imgs && imgs.length) { for (const f of imgs) fd.append('imageFiles', f); }
      if (vids && vids.length) { for (const f of vids) fd.append('videoFiles', f); }
      const res = await fetch(base() + '/post/multipart', { method: 'POST', headers: headers(), body: fd });
      const json = await res.json();
      if (!res.ok || !json.success) throw new Error(json.message || 'create failed');
      const uuid = json.data;
      $("createdUuid").textContent = uuid;
      log('게시물 생성 성공(멀티파트). uuid=' + uuid);
      const url = base() + '/tools/posts-browser.html?uuid=' + encodeURIComponent(uuid);
      $("openBrowser").href = url;
    } catch (e) {
      log('게시물 생성 실패: ' + e.message);
    }
  });

  function renderLocalPreview(){
    // 에디터가 비어있지 않으면 에디터 내용 우선 렌더
    const richHtml = $("richEditor").innerHTML.trim();
  const md = richHtml || $("contentMd").value || '';
    const raw = globalThis.marked ? globalThis.marked.parse(md) : md;
    const safe = globalThis.DOMPurify ? globalThis.DOMPurify.sanitize(raw, {
      ADD_TAGS: ['video','source'],
      ADD_ATTR: ['controls','src','style']
    }) : raw;
    $("mdPreview").innerHTML = safe;
  }

  // 미리보기 렌더
  $("btnPreview").addEventListener('click', () => {
    renderLocalPreview();
  });

  // 생성된 게시물 상세 가져와서 렌더
  $("btnFetchCreated").addEventListener('click', async () => {
    const uuid = $("createdUuid").textContent.trim();
  if (!uuid) { log('먼저 게시물을 생성하세요'); return; }
    try {
      const res = await fetch(base() + '/post/view?uuid=' + encodeURIComponent(uuid));
      const json = await res.json();
      if (!res.ok || !json.success) throw new Error(json.message || 'detail failed');
      const md = (json.data && (json.data.content || json.data.contentMd)) || '';
      const raw = globalThis.marked ? globalThis.marked.parse(md) : md;
      const safe = globalThis.DOMPurify ? globalThis.DOMPurify.sanitize(raw, {
        ADD_TAGS: ['video','source'],
        ADD_ATTR: ['controls','src','style']
      }) : raw;
      $("createdPreview").innerHTML = safe;
  log('상세 로드 성공');
    } catch(e) {
      log('상세 로드 실패: ' + e.message);
    }
  });
})();
</script>
</body>
</html>
