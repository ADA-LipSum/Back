<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>게시물 브라우저</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --pri:#60a5fa; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background: var(--bg); color: #e5e7eb; }
    header { padding: 16px 20px; border-bottom: 1px solid #1f2937; display:flex; align-items:center; gap:12px; }
    header h1 { font-size: 18px; margin: 0; }
    main { padding: 20px; display:grid; grid-template-columns: 320px 1fr; gap: 16px; }
    .card { background: var(--card); border: 1px solid #1f2937; border-radius: 10px; padding: 16px; }
    .card h2 { font-size: 16px; margin: 0 0 12px; }
    label { display:block; font-size: 12px; color: var(--muted); margin: 10px 0 6px; }
    input[type="text"], input[type="password"] { width:100%; background: #0b1220; color:#e5e7eb; border:1px solid #1f2937; border-radius:8px; padding:10px 12px; outline:none; }
    button { background:#1d4ed8; border:none; color:#fff; padding:8px 12px; border-radius:8px; cursor:pointer; }
    button.secondary { background:#334155; }
    .muted { color: var(--muted); font-size: 12px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; font-size:12px; }
    .list { display:flex; flex-direction: column; gap: 10px; }
    .item { border:1px solid #1f2937; border-radius:8px; padding:10px; background:#0b1220; cursor:pointer; }
    .item h3 { margin:0 0 6px; font-size:14px; }
    .controls { display:flex; gap:8px; }
    .md { white-space: pre-wrap; background:#0b1220; border:1px solid #1f2937; border-radius:8px; padding:10px; min-height:160px; }
    .md img, .md video { max-width: 100%; height: auto; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>
<body>
<header>
  <h1>게시물 브라우저</h1>
  <span class="pill" id="authState">미인증</span>
</header>

<main>
  <!-- ✅ 로그인 카드 추가 -->
  <section class="card" style="grid-column: 1 / -1;">
    <h2>로그인</h2>
    <label for="baseUrl">백엔드 베이스 URL (비우면 현재 오리진)</label>
    <input id="baseUrl" type="text" placeholder="예: https://abcd1234.ngrok.io" />

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px;">
      <div>
        <label for="loginId">아이디</label>
        <input id="loginId" type="text" placeholder="admin 또는 custom id" />
      </div>
      <div>
        <label for="loginPw">비밀번호</label>
        <input id="loginPw" type="password" placeholder="password" />
      </div>
    </div>

    <div style="display:flex; gap:8px; margin-top:8px;">
      <button id="btnLogin">로그인</button>
      <button class="secondary" id="btnLogout">로그아웃</button>
    </div>

    <div class="muted" style="margin-top:6px;">토큰: <span id="tokenPreview"></span></div>
  </section>

  <section class="card">
    <h2>목록</h2>
      <div class="controls" style="margin-top:8px;">
      <button id="btnReload">/api/posts 불러오기</button>
      <button class="secondary" id="btnPrev">이전</button>
      <button class="secondary" id="btnNext">다음</button>
    </div>
    <div class="muted" style="margin-top:6px;">page=<span id="page">0</span>, size=<span id="size">10</span></div>
    <div id="list" class="list" style="margin-top:10px;"></div>
  </section>

  <section class="card">
    <h2>상세</h2>
    <div class="muted">선택된 uuid: <span id="sel"></span></div>
    <div id="title" style="margin-top:8px; font-weight:600;"></div>
    <div id="writer" class="muted" style="margin-top:2px;"></div>
    <div id="meta" class="muted" style="margin-top:2px;"></div>
    <div class="md" id="content" style="margin-top:10px;"></div>

    <div id="comments" style="margin-top:20px;">
      <h3 style="font-size:15px;">댓글</h3>
      <div id="commentList" class="list" style="margin-top:10px;"></div>
      <div id="commentForm" style="margin-top:10px;">
        <textarea id="commentContent" placeholder="댓글 내용을 입력하세요"
                  style="width:100%;height:60px;background:#0b1220;color:#e5e7eb;border:1px solid #1f2937;border-radius:8px;padding:10px;"></textarea>
        <button id="btnAddComment" style="margin-top:8px;">댓글 작성</button>
      </div>
    </div>
  </section>
</main>

<script>
  (async function(){
    const $ = (id) => document.getElementById(id);
    const authState = $("authState");
    const tokenPreview = $("tokenPreview");
    const state = {
      page: 0, size: 10, last: false,
      token: localStorage.getItem("accessToken") || ""
    };

    const base = () => $("baseUrl").value.trim() || globalThis.location.origin;
    const headers = () => state.token ? { "Authorization": `Bearer ${state.token}` } : {};

    const setToken = (t) => {
      state.token = t;
      if (t) {
        localStorage.setItem("accessToken", t);
        authState.textContent = "인증됨";
        tokenPreview.textContent = t.slice(0,24) + "...";
      } else {
        localStorage.removeItem("accessToken");
        authState.textContent = "미인증";
        tokenPreview.textContent = "";
      }
    };
    // 초기화
    if (state.token) setToken(state.token);

    // ✅ 로그인 처리
    $("btnLogin").addEventListener("click", async () => {
      const id = $("loginId").value.trim();
      const password = $("loginPw").value;
      try {
        const res = await fetch(base() + "/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, password })
        });
        const json = await res.json();
        if (!res.ok || !json.success) throw new Error(json.message || "login failed");
        const token = json.data?.accessToken;
        if (!token) throw new Error("no accessToken in response");
        setToken(token);
        alert("로그인 성공");
      } catch(e) {
        alert("로그인 실패: " + e.message);
      }
    });

    $("btnLogout").addEventListener("click", () => {
      setToken("");
      alert("로그아웃됨");
    });

    // 목록 불러오기
    async function loadList(){
    const url = `${base()}/api/posts?page=${state.page}&size=${state.size}`;
    const res = await fetch(url);
    const json = await res.json();
    if (!res.ok || !json.success) throw new Error(json.message || "list failed");

    const page = json.data;
    state.last = !!page.last;

    $("page").textContent = page.number ?? state.page;
    $("size").textContent = page.size ?? state.size;

    const list = $("list");
    list.innerHTML = "";

    for (const item of (page.content || [])){

      // 이미지 렌더링
      let imgHtml = "";
      if (Array.isArray(item.images) && item.images.length > 0) {
        const src = item.images[0]; // 첫 번째 이미지
        imgHtml = `<img src="${src}" style="width:100%;border-radius:8px;margin-bottom:8px;" />`;
      }

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        ${imgHtml}
        <h3>${escapeHtml(item.title || "")}</h3>
        <div class="muted">uuid=${item.postUuid}</div>
        <div class="muted">작성자=${escapeHtml(item.writer || "")}</div>
        <div class="muted">
          작성일=${item.writedAt || ""} |
          좋아요=${item.likes || 0} |
          조회=${item.views || 0} |
          댓글=${item.comments || 0}
        </div>
      `;

      div.addEventListener("click", () => loadDetail(item.postUuid));
      list.appendChild(div);
    }
  }

    async function loadDetail(uuid){
      $("sel").textContent = uuid;
      const res = await fetch(`${base()}/api/posts/view?uuid=${encodeURIComponent(uuid)}`);
      const json = await res.json();
      if (!res.ok || !json.success) throw new Error(json.message || "detail failed");
      const d = json.data || {};
      $("title").textContent = d.title || "";
      $("writer").textContent = `작성자: ${d.writer || ""}`;
      $("meta").textContent = `작성일: ${d.writedAt || ""} | 좋아요: ${d.likes || 0} | 조회: ${d.views || 0}`;
      const raw = marked.parse(d.content || d.contentMd || "");
      $("content").innerHTML = DOMPurify.sanitize(raw, { ADD_TAGS:['video','source'], ADD_ATTR:['controls','src','style'] });
      loadComments(uuid);
    }

    async function loadComments(uuid){
      const res = await fetch(`${base()}/api/comments/${encodeURIComponent(uuid)}`);
      const json = await res.json();
      const list = $("commentList");
      list.innerHTML = "";
      if (!res.ok){ list.innerHTML = `<div class="muted">댓글 불러오기 실패</div>`; return; }
      const comments = json || [];
      if (comments.length === 0){
        list.innerHTML = `<div class="muted">아직 댓글이 없습니다.</div>`;
        return;
      }
      for (const c of comments){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<div style="font-weight:600;">${escapeHtml(c.authorName || c.writer || "익명")}</div>
          <div>${escapeHtml(c.content || "")}</div>
          <div class="muted">${c.createdAt || ""}</div>`;
        list.appendChild(div);
      }
    }

    async function addComment(uuid){
      const content = $("commentContent").value.trim();
      if (!content) return alert("내용을 입력하세요.");
      const payload = { postId: uuid, content };
      const res = await fetch(`${base()}/api/comments`, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...headers() },
        body: JSON.stringify(payload)
      });
      if (res.status === 401) return alert("로그인이 필요합니다.");
      const json = await res.json();
      if (!res.ok) return alert(json.message || "댓글 등록 실패");
      $("commentContent").value = "";
      loadComments(uuid);
    }

    function escapeHtml(s){ const div=document.createElement("div"); div.textContent=String(s??""); return div.innerHTML; }

    $("btnReload").addEventListener("click", () => { state.page=0; loadList(); });
    $("btnPrev").addEventListener("click", () => { if(state.page>0){ state.page--; loadList(); } });
    $("btnNext").addEventListener("click", () => { if(!state.last){ state.page++; loadList(); } });
    $("btnAddComment").addEventListener("click", () => {
      const uuid = $("sel").textContent.trim();
      if (uuid) addComment(uuid);
    });

    loadList();
  })();
</script>
</body>
</html>